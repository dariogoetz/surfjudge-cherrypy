{% extends "base_dashboard.html" %}

{% block nav_items %}['#nav_item_admin', '#sidebar_item_edit_heats']{% endblock nav_items %}

{% block title %}Edit Heats{% endblock title %}

{% block sidebar_content %}
{% include "tournament_admin/sidebar.html" %}
{% endblock sidebar_content %}


{% block css %}
{{ super() }}

<link href="/static/datepicker/css/datepicker.css" rel="stylesheet">
<link href="/static/bootstrap-timepicker/css/bootstrap-timepicker.min.css" rel="stylesheet">

<style>
.datepicker{z-index:1151 !important;}
.timepicker{z-index:1151 !important;}
.scrollable-menu{
    height: auto;
    max-height: 200px;
    overflow-x: hidden;
 }

 .surfers_table .selected{background-color: #88FF88 !important;}
 .participants_table .advanced{background-color: #FF8888 !important;}
</style>

{% endblock css %}


{% block content %}

<div class="container-fluid">
    <div class="row">
        <div class="col-xs-3">
            <div class="dropdown">
                <div class="btn-group">
                <button id="tournaments_dropdown_select" class="btn btn-dropdown dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span id="tournaments_dropdown_label">Tournament</span>&nbsp;<span class="caret"></span>
                </button>
                <ul id="tournaments_dropdown_list" class="dropdown-menu scrollable-menu" role="menu" aria-labelledby="tournaments_dropdown_label">
                </ul>
                </div>
            </div>
        </div>

        <div class="col-xs-3">
            <div class="dropdown">
                <div class="btn-group">
                <button id="categories_dropdown_select" class="btn btn-dropdown dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span id="categories_dropdown_label">Category</span>&nbsp;<span class="caret"></span>
                </button>
                <ul id="categories_dropdown_list" class="dropdown-menu scrollable-menu" role="menu" aria-labelledby="categories_dropdown_label">
                </ul>
                </div>
            </div>
        </div>
    </div>

    <br>


    <div id="data_section"  style="display:none">
        <button type="button" class="btn btn-standard btn-lg new_heat_btn"><span class="glyphicon glyphicon-plus">&nbsp;</span>New Heat</button>
        <br><br>

        <table class="table table-striped"
               id="heats_table"
               data-toggle="table"
               data-url="{{ mount_loc }}/do_get_heats"
               data-sort-name="name"
               date-sort-order="asc">
            <thead>
                <tr>
                    <th data-field="id">ID (for admin)</th>
                    <th data-field="name" data-sortable="true">Heat Name</th>
                    <th data-field="date" data-sortable="true">Date</th>
                    <th data-field="start_time" data-sortable="true">Start Time</th>
                    <th data-field="number_of_waves" data-sortable="true">Number of Waves</th>
                    <th data-field="additional_info">Additional Info</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
{% endblock content %}


{% block javascript %}
{{ super() }}

<script>
 // ***** DROPDOWN *****

 function refresh_tournaments(){
     // fill dropdown with tournament names
     $.get('{{ mount_loc }}/do_get_tournaments', function(data){
         var tournaments = JSON.parse(data);
         // sort
         function comp_func(a,b){
             return (b['start_datetime'] < a['start_datetime']) ? 1 : -1;
         }

         tournaments.sort(comp_func);

         // fill dropdown list with sorted tournament names
         $('#tournaments_dropdown_list').empty();
         for (i in tournaments){
             $('#tournaments_dropdown_list').append('<li><a class="select" href="#" data-name="' + tournaments[i]['name'] + '" data-index=' + tournaments[i]['id'] + '>' + tournaments[i]['name'] + '</a></li>');
         };
     });
     $('#tournaments_dropdown_label').html('Tournament');
     $('#tournaments_dropdown_select').data('select', null);
     refresh_categories();
     $('#data_section').hide();
 };

 function refresh_categories(tournament_id){
     if (typeof tournament_id !== 'undefined'){
         $.get('{{ mount_loc }}/do_get_categories',{tournament_id: tournament_id}, function(data){
             var categories = JSON.parse(data);
             $('#categories_dropdown_list').empty();
             for (i in categories){
                 $('#categories_dropdown_list').append('<li><a class="select" href="#" data-name="' + categories[i]['name'] + '" data-index=' + categories[i]['id'] + '>' + categories[i]['name'] + '</a></li>');
             };
         });
     };
     $('#categories_dropdown_label').html('Category');
     $('#categories_dropdown_select').data('select', null);
     $('#data_section').hide();
 };


 $('#tournaments_dropdown_list').on('click', '.select', function(e){
     tid =  $(this).data('index');
     $('#tournaments_dropdown_label').html('Tournament <b>' + $(this).data('name') + '</b>');
     $('#tournaments_dropdown_select').data('select', tid);
     refresh_categories(tid);
 });
 $('#categories_dropdown_list').on('click', '.select', function(e){
     $('#categories_dropdown_label').html('Category <b>' + $(this).data('name') + '</b>');
     $('#categories_dropdown_select').data('select', $(this).data('index'));
     refresh_data_table();
 });

 function refresh_data_table(){
     var tid = $('#tournaments_dropdown_select').data('select');
     var cid = $('#categories_dropdown_select').data('select');
     query = {}
     if (typeof cid !== 'undefined')
         query['category_id'] = cid;

     $('#heats_table').bootstrapTable('refresh', {url:'{{ mount_loc }}/do_get_heats', query: query});
     $('#data_section').show();
 };

</script>

<script>

 // register functionality for "new heat" button
 $('.new_heat_btn').on('click', function(){
     heat = new Heat({category_id: $('#categories_dropdown_select').data('select')});
     heat.fill_heat_modal();
  $('#edit_heat_modal').modal('toggle');
  });

// register functionality for selecting heats from table
$('#heats_table').on('click-row.bs.table', function (e, row, $element) {
    if (typeof(row) !== 'undefined'){
        row['category_id'] = $('#categories_dropdown_select').data('select');
        heat = new Heat(row);
        heat.fill_heat_modal();
        $('#edit_heat_modal').modal('toggle');
    };
 });

</script>

<script>
 $(document).ready(function(){
     refresh_tournaments();
 });
</script>

{% endblock javascript %}



{% block modals %}
<!-- Edit heats modal -->
<div class="modal fade" id="edit_heat_modal">
    <div class="modal-dialog">
      <div class="modal-content">

          <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title">Edit Heat</h4>
          </div> <!-- /.modal-header -->

          <div class="modal-body">


          <div class="well">
              <div class="form-horizontal">
                  <div class="form-group">
                      <label class="col-sm-2 control-label">Heat name</label>
                      <div class="col-sm-10">
                          <input type="hidden" id="modal_heat_id">
                          <input type="text" id="modal_heat_name" name="heat_name" class="form-control" placeholder="Heat Name">
                      </div>
                  </div>
                  <div class="form-group">
                      <label class="col-xs-2 control-label">Date</label>
                      <div class="row">
                        <div class="col-xs-5">

			              <div class="input-group date" id="modal_date_picker" data-date="" data-date-format="dd.mm.yyyy">
				              <input class="form-control" id="modal_date_input" size="16" type="text" placeholder="Date start" readonly>
				              <span class="input-group-addon add-on"><i class="glyphicon glyphicon-calendar"></i></span>
			              </div>
                        </div>
                        <div class="col-xs-4">
                            <div class="input-group bootstrap-timepicker timepicker">
                                <input id="modal_time_picker" data-minute-step="15" data-show-meridian="false" class="form-control" type="text">
				              <span class="input-group-addon add-on"><i class="glyphicon glyphicon-time"></i></span>
                            </div>
                        </div>
                      </div>
                  </div>

                  <div class="form-group">
                      <label class="col-xs-2 control-label">Number of waves</label>
                      <div class="col-xs-10">

                          <div class="input-group">
                              <span class="input-group-btn">
                                  <button type="button" class="btn btn-danger btn-number"  data-type="minus" data-field="nwaves">
                                      <span class="glyphicon glyphicon-minus"></span>
                                  </button>
                              </span>
                              <input type="text" id="modal_nwaves" name="nwaves" class="form-control input-number" placeholder="10" min="1" max="100" value = "10"">
                              <span class="input-group-btn">
                                  <button type="button" class="btn btn-success btn-number" data-type="plus" data-field="nwaves">
                                      <span class="glyphicon glyphicon-plus"></span>
                                  </button>
                              </span>
                          </div>
                      </div>
                  </div>

                  <div class="form-group">
                      <label class="col-xs-2 control-label">Additional Info</label>
                      <div class="col-xs-10">
                        <input type="text" id ="modal_additional_info" name="modal_additional_info" class="form-control" placeholder="Additional Info">
                      </div>
                  </div>
              </div>
              <h4>Participating Surfers</h4>
              <table class="table table-striped participants_table">
                  <thead>
                      <tr>
                          <th data-field="seed">Seed</th>
                          <th data-field="name">Surfer Name</th>
                          <th data-field="color">Surfer Color</th>
                          <th data-field="action">Action</th>
                      </tr>
                  </thead>
                  <tbody>
                  </tbody>
              </table>
              <a class="btn btn-standard add_participant_btn"><span class="glyphicon glyphicon-plus">&nbsp;</span>Add Participant</a>
          </div>

      </div><!-- /.modal-body -->


      <div class="modal-footer">
        <button id="heat_delete" class="btn btn-danger pull-left">Delete</button>
        <button class="btn btn-default" data-dismiss="modal">Cancel</button>
        <button class="btn btn-primary heat_submit">Save changes</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Edit participants modal -->
<div class="modal fade add_participant_modal">
    <div class="modal-dialog">
      <div class="modal-content">

          <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title">Edit Participants</h4>
          </div> <!-- /.modal-header -->

          <div class="modal-body">
              <div class="well">

                  <div class="row">
                      <table class="table table-striped surfers_table"
                             data-toggle="table"
                             data-sort-name="name"
                             date-sort-order="asc"
                             data-search=true
                             data-height="300">
                          <thead>
                              <tr>
                                  <th data-field="name">Surfer Name</th>
                              </tr>
                          </thead>
                          <tbody>
                          </tbody>
                      </table>
                  </div>
              </div>

          </div><!-- /.modal-body -->
          <div class="modal-footer">
              <button class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button class="btn btn-primary participant_submit" data-dismiss="modal">Save changes</button>
          </div>

      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

{% endblock modals %}

{% block modal_javascript %}
<!-- modal scripts -->

<script src="/static/datepicker/js/bootstrap-datepicker.js"></script>
<script src="/static/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script src="/static/plusminusinput/plusminusinput.js"></script>

<script>
 // ***** MODAL internals *****

 // click on confirm button for pending participant row
 $('.participants_table').on('click', '.remove_pending_btn', function(){
     heat.remove_pending($(this).data('seed'))
 });

 $('.participants_table').on('click', '.remove_participant_btn', function(){
     heat.remove_participant($(this).data('seed'));
 });

 $('.participants_table').on('click', '.edit_participant_btn', function(){
    heat.refresh_surfers_table();
    $('.add_participant_modal').data('seed', $(this).data('seed'));
    $('.add_participant_modal').modal('toggle');
 });



 $('.add_participant_btn').on('click', function(){
    heat.refresh_surfers_table();
    $('.add_participant_modal').data('seed', 'new');
    $('.add_participant_modal').modal('toggle');
 });


 $('.surfers_table').on('click-row.bs.table', function(e, row, $element){
     var $apm = $('.add_participant_modal');
     $apm.data('participant', row);
     if ($apm.data('selected_element'))
         $apm.data('selected_element').children().removeClass('selected');
     $apm.data('selected_element', $element);
     $element.children().addClass('selected');
 });

// click on "save" in second modal to select participants
  $('.participant_submit').on('click', function(){
      var $apm = $('.add_participant_modal');
      if (!(typeof $apm.data('participant')['id'] === 'undefined')){
          heat.set_participant($apm.data('seed'), $apm.data('participant'));
      }
      else
          console.log('nothing to submit');
  });

 $('#heat_delete').on('click', function(){
     var tournament_id = $('#tournaments_dropdown_select').data('select');
     var category_id = $('#categories_dropdown_select').data('select');
     var heat_id = $('#modal_heat_id').val();

     $.post('{{ mount_loc }}/do_delete_heat', {id: heat_id});
     $('#edit_heat_modal').modal('toggle');
     $('#heats_table').bootstrapTable('refresh', {url:'{{ mount_loc }}/do_get_heats', query: {category_id: category_id}});
 });

 $('.heat_submit').on('click', function(){
     heat.fetch_heat_details_from_modal();
     heat.fetch_surfer_colors();
     var okay = heat.check_data();
     if (okay){
         heat.upload_data();
         $('#edit_heat_modal').modal('toggle');
     }
 });

</script>


<!-- enable datepickers in modal window -->
<script>
 // ***** DATEPICKER *****

 $('#modal_date_picker').datepicker({weekStart: 1})
                        .on('changeDate', function(ev){
                            $('#modal_date_picker').datepicker('hide');
                        });
 $('#modal_time_picker').timepicker();

</script>


<script>
 function Heat(row){
     if (typeof row === 'undefined')
         row = {};
     this.heat_id = row['id'];
     this.category_id = row['category_id'];
     this.heat_name = row['name'];
     this.date = row['date'];
     this.start_time = row['start_time'];
     this.number_of_waves = row['number_of_waves'];
     this.additional_info = row['additional_info'];

     this.colors = {{ lycra_colors }};

     this.surfers = [];
     this.participants = [];
     this.advanced_participants = [];

     this.init();
 }

 Heat.prototype.init = function(){
     function rowStyle(row, index){
         var res = {};
         if (row['advanced'])
             res['classes'] = 'advanced';
         return res;
     }
     $('.participants_table').bootstrapTable({'rowStyle': rowStyle});
     $('.surfers_table').bootstrapTable();
     this.refresh_from_server();
 }

 Heat.prototype.refresh_from_server = function(){
     var _this = this;
     this.get_data().done(function(){
         _this.refresh_surfers_table();
         _this.refresh_participants_table();
     });
}

 Heat.prototype.get_data = function(){
     this.surfers = [];
     this.participants = [];
     this.advanced_participants = [];
     var deferred_surfers = $.getJSON('{{ mount_loc }}/do_get_surfers');
     var deferred_participants = $.getJSON('/headjudge/do_get_participating_surfers', {heat_id: this.heat_id, fill_advance: true});
     var deferred_advanced = $.getJSON('{{ mount_loc }}/do_get_advancing_surfers', {heat_id: this.heat_id});

     var _this = this;

     return $.when(deferred_surfers, deferred_participants, deferred_advanced).done(function(ev_surfers, ev_participants, ev_advanced){
         _this.surfers = ev_surfers[0];
         _this.participants = ev_participants[0];
         _this.advanced_participants = ev_advanced[0];
     });
 }

 Heat.prototype.refresh_surfers_table = function(){
     $('.add_participant_modal').data('participant', {});
     $('.surfers_table').bootstrapTable('load', this.get_nonparticipating_surfers());
 }


 Heat.prototype.refresh_participants_table = function(){
     var res = [];
     for (idx=0; idx < this.participants.length; idx++){
         // fill table in edit_heat modal
         if (this.participants[idx])
             res.push(this._add_interactive_fields(this.participants[idx]));
     }

     $('.participants_table').bootstrapTable('load', res);
 }

 Heat.prototype._add_interactive_fields = function(participant){
     var s = '<select class="form-control"  data-seed="' + participant['seed'] + '">';
     for (var val in this.colors) {
         var sel = '';
         if (participant['surfer_color'] === this.colors[val])
             sel = 'selected=true';
         s = s + '<option ' + sel + ' value="' + this.colors[val] + '">' + this.colors[val] + '</option>';
     }
     s = s + '</select>';

     var action_field = '';
     if (participant['advanced']){
         action_field = '<a href="#" data-seed=' + participant['seed'] + ' class="remove_pending_btn"><button class="btn btn-success"><span class="glyphicon glyphicon-ok"></span></button></a>';
     } else {
         action_field = '<a href="#" data-seed=' + participant['seed'] + ' class="remove_participant_btn"><button class="btn btn-danger"><span class="glyphicon glyphicon-remove"></span></button></a>';
     }
     var edit_field = '&nbsp; <a href="#" data-seed=' + participant['seed'] + ' class="edit_participant_btn"><button class="btn btn-info"><span class="glyphicon glyphicon-edit"></span></button></a>';

     var res = $.extend({}, participant);
     res['color'] = s;
     res['action'] = action_field + edit_field;
     return res;
 }


 Heat.prototype.get_confirmed_participants = function(){
     var res = [];
     for (idx=0; idx < this.participants.length; idx++){
         if (this.participants[idx] && !this.participants[idx]['advanced']){
             res.push(this.participants[idx]);
         }
     }
     return res;
 }

 Heat.prototype.get_nonparticipating_surfers = function(){
     var surfers = [];
     var p = this.get_confirmed_participants();
     var p_set = new Set();
     for (idx=0; idx < p.length; idx++){
         p_set.add(p[idx]['surfer_id']);
     }
     for (idx=0; idx < this.surfers.length; idx++){
         if (!p_set.has(this.surfers[idx]['id']))
             surfers.push(this.surfers[idx]);
     }
     return surfers;
 }

 Heat.prototype.remove_participant = function(seed){
     if (seed >= this.advanced_participants.length)
         this.participants[seed] = null;
     else
         this.participants[seed] = $.extend({}, this.advanced_participants[seed]);
     this.refresh_participants_table();
     this.refresh_surfers_table();
 }

 Heat.prototype.confirm_participant = function(seed){
     if (!(typeof this.participants[seed]['advanced'] === 'undefined'))
         delete this.participants[seed]['advanced'];
 }

 Heat.prototype.set_participant = function(seed, data){
     var new_seed = -1;
     if (seed == 'new')
         new_seed = this.participants.length;
     else
         new_seed = parseInt(seed);
     var existing_participant = this.participants[new_seed];
     this.participants[new_seed] = data;
     if (existing_participant){
         this.participants[new_seed]['surfer_color'] = existing_participant['surfer_color'];
     }
     else {
         var color = this.get_available_color();
         if (color)
             this.participants[new_seed]['surfer_color'] = color;
     }
     this.participants[new_seed]['seed'] = new_seed;
     this.participants[new_seed]['surfer_id'] = this.participants[new_seed]['id'];
     this.participants[new_seed]['heat_id'] = this.heat_id;
     this.refresh_surfers_table();
     this.refresh_participants_table();
 }


 Heat.prototype.fetch_heat_details_from_modal = function(){
     this.heat_id = $('#modal_heat_id').val();
     this.heat_name = $('#modal_heat_name').val();
     this.date = $('#modal_date_input').val();
     this.start_time = $('#modal_time_picker').val();
     this.number_of_waves = $('#modal_nwaves').val();
     if (this.number_of_waves==='')
         this.number_of_waves = 10;
     this.additional_info = $('#modal_additional_info').val();
 }

 Heat.prototype.check_data = function(){

     if (this.heat_id == null && this.heat_name.length == 0) {
         alert('Empty field "Heat Name"');
         return false;
     };

     var colors = new Set();
     for (idx = 0; idx < this.participants.length; idx++){
         if (this.participants[idx] && !this.participants[idx]['advanced']){
             var color = this.participants[idx]['surfer_color'];
             if (colors.has(color)){
                 alert('Double entries for "Surfer Color"');
                 return false;
             }
             colors.add(color);
         }
     }
     return true;
 }

 Heat.prototype.fetch_surfer_colors = function(){
     var _this = this;

     $('.participants_table select option:selected').each(function(){
         var seed = parseInt($(this).parent().data('seed'));
         if (!_this.participants[seed]['advanced']){
             _this.participants[seed]['surfer_color'] = $(this).val();
         }
     });
 }

 Heat.prototype.get_available_color = function(){
     this.fetch_surfer_colors();
     var taken_colors = new Set();
     for (idx = 0; idx < this.participants.length; idx++){
         if (this.participants[idx] && !this.participants[idx]['advanced']){
             var color = this.participants[idx]['surfer_color'];
             taken_colors.add(color);
         }
     }
     for (idx = 0; idx < this.colors.length; idx++){
         var color = this.colors[idx];
         if (! taken_colors.has(color))
             return color;
     }
     return null;
 }

 Heat.prototype.upload_data = function(){
     var _this = this;

     this.fetch_heat_details_from_modal();
     this.fetch_surfer_colors();
     var okay = this.check_data();
     if (!okay){
         return;
     }

     var heat_data = {heat_id: this.heat_id, heat_name: this.heat_name, category_id: this.category_id, date: this.date, start_time: this.start_time, number_of_waves: this.number_of_waves, additional_info: this.additional_info};
     var participants = JSON.stringify(this.get_confirmed_participants());

     console.log('uploading');

     var deferred_heat_data = $.post('{{ mount_loc }}/do_edit_heat', heat_data);
     var deferred_participants = $.post('{{ mount_loc }}/do_set_participating_surfers', {heat_id: this.heat_id, participants: participants});

     return $.when(deferred_heat_data, deferred_participants).done(function(ev_heat_data, ev_part){
         _this.heat_id = ev_heat_data[0];
         $('#heats_table').bootstrapTable('refresh', {url:'{{ mount_loc }}/do_get_heats', query: {category_id: _this.category_id}});
         _this.refresh_from_server();
     });
 }

 Heat.prototype.fill_heat_modal = function(){
     // ***** NEW HEAT BUTTON *****
     $('#modal_heat_id').val(this.heat_id);
     $('#modal_heat_name').val(this.heat_name);
     if (this.date == null){
         $('#modal_date_picker').data('datepicker').setValue('');
     } else {
         $('#modal_date_picker').data('datepicker').setValue(this.date);
     }
     if (this.start_time == null){
     } else {
         $('#modal_time_picker').timepicker('setTime', this.start_time);
     }
     // time picker
     $('#modal_nwaves').val(this.number_of_waves);
     $('#modal_additional_info').val(this.additional_info);

     this.refresh_participants_table();
 }

Heat.prototype.remove_pending = function(seed){
     heat.confirm_participant(seed);
     heat.refresh_participants_table();
 }

</script>

{% endblock modal_javascript %}
