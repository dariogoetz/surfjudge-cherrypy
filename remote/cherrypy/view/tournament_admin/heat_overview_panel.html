<link href="/static/datepicker/css/datepicker.css" rel="stylesheet">
<link href="/static/surfjudge/css/heat.css" rel="stylesheet">
<link href="/static/surfjudge/css/judging_requests.css" rel="stylesheet">


<div class="container-fluid" data-heat_id={{ heat_id }} data-categoryid={{ category_id }} id="heat_overview_{{ heat_id }}">
    <h1>"{{ heat_name }}" in "{{ category_name }}"</h1>



    <!-- start/stop and publish/export -->
    <button class="btn btn-default btn-lg pull-right refresh_btn"><span class="glyphicon glyphicon-refresh">&nbsp;Refresh</span></button>
    <h3>Activities</h3>
    <div class="well">
        <div class="row">
        <div class="col-xs-4">
            <button class="btn btn-default btn-lg heat_activity_btn" data-heat_id={{ heat_id }} data-status="inactive">Start/Stop Heat</button>
        </div>
        <div class="col-xs-4">
            <div class="btn-group">
                <button class="btn btn-default btn-lg publish_btn" data-heat_id="{{ heat_id }}">Publish</button>
                <button class="btn btn-danger btn-lg unpublish_btn" data-heat_id="{{ heat_id }}"><span class="glyphicon glyphicon-remove"></span></button>
            </div>
        </div>
        <div class="col-xs-4">
            <button class="btn btn-standard btn-lg export_btn pull-right">Export Excel</button>
        </div>
        </div>
        <div class="row">
            <!-- Heat Timer -->
            <h1 class="heat_time">00:00</h1>
        </div>
    </div>

    <!-- judging requests -->
    <h3>Judging Requests</h3>
    <table class="table table-striped judging_requests_table"
           data-toggle="table"
           data-sort-name="judge_id"
           date-sort-order="asc">
        <thead>
            <tr>
                <th data-field="judge_id">Judge ID</th>
                <th data-field="name" data-sortable="true">Judge Name</th>
                <th data-field="expires" data-sortable="true">Expires</th>
                <th data-field="status" data-sortable="true">Status</th>
                <th data-field="action"">Action</th>
            </tr>
        </thead>
    </table>


    <!-- edit_heat -->
    <h3>Edit Heat</h3>
    <div class="well">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-2 control-label">Heat name</label>
                <div class="col-sm-10">
                    <input type="hidden" class="heat_input" data-key="heat_id">
                    <input type="text" name="heat_input_name" class="form-control heat_input" data-key="heat_name" placeholder="Heat Name">
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-2 control-label">Date</label>
                <div class="row">
                    <div class="col-xs-5">

			            <div class="input-group date date_picker" data-date="" data-date-format="dd.mm.yyyy">
				            <input class="form-control heat_input" data-key="date" id="input_date_input" size="16" type="text" placeholder="Date start" readonly>
				            <span class="input-group-addon add-on"><i class="glyphicon glyphicon-calendar"></i></span>
			            </div>
                    </div>
                    <div class="col-xs-4">
                        <div class="input-group bootstrap-timepicker timepicker">
                            <input data-minute-step="15" data-show-meridian="false" class="form-control heat_input time_picker" data-key="start_time" type="text">
				            <span class="input-group-addon add-on"><i class="glyphicon glyphicon-time"></i></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="col-xs-2 control-label">Number of waves</label>
                <div class="col-xs-10">

                    <div class="input-group plusminusinput">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-danger btn-number"  data-type="minus" data-field="nwaves">
                                <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </span>
                        <input type="text" id="input_nwaves" name="nwaves" class="form-control input-number heat_input" data-key="number_of_waves" placeholder="10" min="1" max="100" value = "10"">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-success btn-number" data-type="plus" data-field="nwaves">
                                <span class="glyphicon glyphicon-plus"></span>
                            </button>
                        </span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="col-xs-2 control-label">Duration [min]</label>
                <div class="col-xs-10">

                    <div class="input-group plusminusinput">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-danger btn-number"  data-type="minus" data-field="duration">
                                <span class="glyphicon glyphicon-minus"></span>
                            </button>
                        </span>
                        <input type="text" name="duration" class="form-control input-number heat_input" data-key="duration" placeholder="15" min="1" max="120" value = "10"">
                        <span class="input-group-btn">
                            <button type="button" class="btn btn-success btn-number" data-type="plus" data-field="duration">
                                <span class="glyphicon glyphicon-plus"></span>
                            </button>
                        </span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="col-xs-2 control-label">Additional Info</label>
                <div class="col-xs-10">
                    <input type="text" id ="input_additional_info" name="input_additional_info" class="form-control heat_input" data-key="additional_info" placeholder="Additional Info">
                </div>
            </div>
        </div>

        <h4>Participating Surfers</h4>
        <table class="table table-striped participants_table">
            <thead>
                <tr>
                    <th data-field="seed">Seed</th>
                    <th data-field="name">Surfer Name</th>
                    <th data-field="color">Surfer Color</th>
                    <th data-field="action">Action</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <a class="btn btn-standard add_participant_btn"><span class="glyphicon glyphicon-plus">&nbsp;</span>Add Participant</a>

    </div>
</div>



<script src="/static/datepicker/js/bootstrap-datepicker.js"></script>
<script src="/static/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
<script src="/static/plusminusinput/plusminusinput.js"></script>

<script>
 $('#heat_overview_{{ heat_id }} .date_picker').datepicker({weekStart: 1})
                        .on('changeDate', function(ev){
                            $(this).datepicker('hide');
                        });
 $('#heat_overview_{{ heat_id }} .time_picker').timepicker();

 $('#heat_overview_{{ heat_id }}').on('click', '.export_btn', function(){
     // trigger file download
     window.location.replace('/export_scores?heat_id={{ heat_id }}');
 });

 $('#heat_overview_{{ heat_id }}').on('click', '.publish_btn', function(){
     $.get('/headjudge/do_publish_results', {heat_id: {{ heat_id }}}, function(){
         //alert('Published Results for Heat '+ {{ heat_id }});
         refresh({{ heat_id }});
     });
 });

 $('#heat_overview_{{ heat_id }}').on('click', '.unpublish_btn', function(){
     $.get('/headjudge/do_delete_published_results', {heat_id: {{ heat_id }}}, function(){
         //alert('Published Results for Heat '+ {{ heat_id }});
         refresh({{ heat_id }});
     });
 });

 $('#heat_overview_{{ heat_id }}').on('click', '.refresh_btn', function(){
     refresh({{ heat_id }});
 });

 $('#heat_overview_{{ heat_id }} .heat_activity_btn').on('click', function(e){
     var _this = this;
     var tmp = $('#heat_overview_{{ heat_id }}').heat('upload_data');
     tmp.done(function(){
         var jqxhr = null;
         if ($(_this).data('status') == 'inactive'){
             jqxhr = activate($(_this));
         }
         else {
             jqxhr = deactivate($(_this));
         }
         jqxhr.success(function(){
             refresh({{ heat_id }});
         });
     });

 });

 function refresh(heat_id){
     // refresh the various fields
     refresh_activity(heat_id);
     refresh_published(heat_id);
     refresh_heat_info(heat_id);
     refresh_judging_requests(heat_id);
 }

 function refresh_judging_requests(heat_id){
     if ($('#heat_overview_' + heat_id).data('judging_requests')){
         $('#heat_overview_' + heat_id).judging_requests('destroy');
     }
     $('#heat_overview_' + heat_id).judging_requests({heat_id: heat_id});
 }

 function refresh_published(heat_id){
     var pub_btn = $('#heat_overview_' + heat_id + ' .publish_btn');
     $.getJSON('/do_get_published_scores', {heat_id: heat_id}, function(data){
         if (data.length > 0){
             $(pub_btn).text('RE-publish');
         }
         else {
             $(pub_btn).text('Publish');
         }
     });
 }

 function refresh_heat_info(heat_id){
     $.getJSON('/tournament_admin/do_get_heat_info', {heat_id: heat_id}, function(heat_info){
         var options = $.extend(heat_info, {'surfers_modal': '#add_participant_modal'});
         if ($('#heat_overview_' + heat_id).data('heat'))
             $('#heat_overview_' + heat_id).heat('destroy');
         var heat = $('#heat_overview_' + heat_id).heat(options);//heat = new Heat(heat_info, '#heat_overview_' + heat_id);
         $('#heat_overview_' + heat_id).heat('fill_heat_inputs');
         heat_durations[heat_id] = heat_info['duration'];
         set_heat_time(heat_id);
     });
 }


 function refresh_activity(heat_id){
     $.getJSON('/do_get_all_active_heats', function(active_heats){
         var ha_btn = $('#heat_overview_' + heat_id + ' .heat_activity_btn');
         var active_heat_ids = new Set();
         for (var idx in active_heats){
             active_heat_ids.add(active_heats[idx]['heat_id']);
         }
         if (active_heat_ids.has(heat_id)){
             visualize_active(ha_btn);
         }
         else {
             visualize_inactive(ha_btn);
         }
     });
 }

 function visualize_active(elem){
     elem.addClass('btn-danger');
     elem.removeClass('btn-success');
     elem.data('status', 'active');
     elem.text('Stop Heat');
 }

 function visualize_inactive(elem){
     elem.addClass('btn-success');
     elem.removeClass('btn-danger');
     elem.data('status', 'inactive');
     elem.text('Start Heat');
 }

 function activate(elem){
     var jqxhr = $.post('/headjudge/do_activate_heat', {heat_id: elem.data('heat_id')});
     jqxhr.success(function(){
         visualize_active(elem);
     });
     return jqxhr;
 };
 function deactivate(elem){
     var jqxhr = $.post('/headjudge/do_deactivate_heat', {heat_id: elem.data('heat_id')});
     jqxhr.success(function(){
         visualize_inactive(elem);
     });
     return jqxhr;
 };

</script>


<script>
 if (typeof heat_end_time == 'undefined')
     heat_end_time = {};
 if (typeof heat_durations == 'undefined')
     heat_durations = {};

 // init timer
 function set_heat_time(heat_id){
     var hd = heat_durations[heat_id];
     if (hd == null)
         hd = 0;
     $('.heat_time').text(hd + ':00');
     if (typeof timer != 'undefined')
         clearInterval(timer);

     $.getJSON('/headjudge/do_get_remaining_heat_time', {heat_id: heat_id}, function(remaining_heat_time_s){
         var now = new Date();

         if (remaining_heat_time_s == null){
             heat_end_time[heat_id] = now;
         } else {
             heat_end_time[heat_id] = new Date(now.getTime() + remaining_heat_time_s * 1000);
             update_heat_time(heat_id);
             timer = setInterval(function(){update_heat_time(heat_id);}, 1000);
         }
     });
 }

 function update_heat_time(heat_id){
     var now = new Date();
     var heat_time = Math.ceil((heat_end_time[heat_id].getTime() - now.getTime())/1000);
     if (heat_time < 0)
         heat_time = 0;
     var minutes = '' + parseInt(heat_time / 60);
     var seconds = '' + parseInt(heat_time % 60);
     while (seconds.length < 2) seconds = '0' + seconds;
     while (minutes.length < 2) minutes = '0' + minutes;
     $('.heat_time').text(minutes + ':' + seconds);
 }
</script>
